<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#D4A574">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Alphabet Nachspuren ‚Äì Kidsneed</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --s-1:8px;--s-2:16px;--s-3:24px;--s-4:32px;
      --radius-sm:12px;--radius-md:16px;--radius-lg:24px;--radius-xl:28px;
      --shadow-soft:0 2px 10px rgba(45,42,38,.10);--shadow-subtle:0 1px 3px rgba(45,42,38,.06);
      --bg-canvas:#F5F0E8;--bg-card:#FFFFFF;--bg-muted:#EDE8DC;
      --ink-primary:#2D2A26;--ink-secondary:#6B665C;--ink-light:#9C9588;
      --accent:#D4A574;--accent-light:rgba(212,165,116,.12);--accent-dark:#B48554;
      --color-success:#7BA08A;--color-success-bg:rgba(123,160,138,.15);
      --color-error:#C4726C;--color-error-bg:rgba(196,114,108,.15);
      --color-warn:#D4A574;--color-warn-bg:rgba(212,165,116,.15);
      --text-2xl:24px;--text-xl:20px;--text-lg:18px;--text-md:16px;--text-sm:14px;--text-xs:12px;
      --motion-fast:150ms;--ease-out:cubic-bezier(0.33,1,0.68,1);
      --app-max-w:600px;--font:'Nunito',system-ui,sans-serif;
    }
    *,*::before,*::after{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{margin:0;background:var(--bg-canvas);color:var(--ink-primary);font-family:var(--font);font-weight:600;font-size:var(--text-md);line-height:1.5;display:flex;align-items:center;justify-content:center;overflow:hidden}
    *:focus-visible{outline:3px solid var(--accent);outline-offset:2px;border-radius:var(--radius-sm)}
    @media(prefers-reduced-motion:reduce){*{transition-duration:0.01ms!important;animation-duration:0.01ms!important}}

    .app-frame{width:100%;height:100%;background:var(--bg-card);display:flex;flex-direction:column;overflow:hidden;position:relative}
    @media(min-width:520px){body{padding:var(--s-3)}.app-frame{max-width:var(--app-max-w);height:94dvh;max-height:940px;border:3px solid var(--ink-primary);border-radius:var(--radius-lg);box-shadow:var(--shadow-subtle)}}

    header{height:72px;padding:0 var(--s-3);display:flex;align-items:center;justify-content:space-between;gap:var(--s-2);border-bottom:3px solid var(--ink-primary);background:var(--bg-card);flex:0 0 auto}
    .brand{display:flex;flex-direction:column;gap:2px;min-width:0}
    .brand-title{font-size:var(--text-xl);font-weight:900;letter-spacing:-0.02em;line-height:1.1;display:flex;align-items:center;gap:var(--s-1)}
    .brand-subtitle{font-size:var(--text-xs);font-weight:900;text-transform:uppercase;letter-spacing:.10em;color:var(--ink-secondary)}
    .header-stats{display:flex;gap:var(--s-1);align-items:center}

    .pill{min-height:48px;padding:10px 12px;border-radius:var(--radius-sm);border:2px solid var(--ink-primary);background:var(--bg-muted);display:flex;align-items:center;gap:6px;user-select:none;cursor:pointer;transition:transform var(--motion-fast) var(--ease-out)}
    .pill:hover{box-shadow:var(--shadow-soft);transform:translateY(-1px)}
    .pill:active{transform:scale(0.98)}
    .pill .icon{font-size:16px}
    .pill .val{font-weight:900;font-size:var(--text-sm);font-variant-numeric:tabular-nums}

    .viewport{flex:1;overflow-y:auto;padding:var(--s-3);background:radial-gradient(1200px 340px at 50% 0%,rgba(212,165,116,.10),transparent 60%),var(--bg-card);overscroll-behavior:contain}

    .card{border:3px solid var(--ink-primary);border-radius:var(--radius-lg);background:var(--bg-card);box-shadow:var(--shadow-subtle);margin-bottom:var(--s-3)}
    .card-section{padding:var(--s-3)}
    .card-section+.card-section{border-top:3px solid var(--ink-primary)}
    .section-label{font-size:var(--text-xs);font-weight:900;text-transform:uppercase;letter-spacing:.10em;color:var(--ink-secondary);margin-bottom:var(--s-2)}

    /* Mode Tabs */
    .mode-tabs{display:flex;gap:var(--s-1);margin-bottom:var(--s-2)}
    .mode-tab{flex:1;min-height:48px;padding:12px;border-radius:var(--radius-sm);border:2px solid var(--ink-primary);background:var(--bg-muted);font-family:var(--font);font-weight:900;font-size:var(--text-sm);color:var(--ink-secondary);cursor:pointer;transition:all var(--motion-fast) var(--ease-out);text-align:center}
    .mode-tab:hover{transform:translateY(-1px);box-shadow:var(--shadow-soft)}
    .mode-tab.active{background:var(--accent);color:white;border-color:var(--accent-dark)}

    /* Progress */
    .progress-wrap{margin-bottom:var(--s-2)}
    .progress-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--s-1)}
    .progress-label{font-size:var(--text-xs);font-weight:900;text-transform:uppercase;letter-spacing:.08em;color:var(--ink-secondary)}
    .progress-counter{font-size:var(--text-md);font-weight:900;color:var(--accent)}
    .progress-bar{height:12px;background:var(--bg-muted);border:2px solid var(--ink-primary);border-radius:6px;overflow:hidden}
    .progress-fill{height:100%;background:var(--accent);border-radius:4px;transition:width .3s var(--ease-out);width:0}

    /* Word Display */
    .word-display{background:var(--bg-muted);border:2px solid var(--ink-primary);border-radius:var(--radius-md);padding:var(--s-2);margin-bottom:var(--s-2);text-align:center;display:none}
    .word-display.active{display:block}
    .word-letters{display:flex;justify-content:center;gap:4px;flex-wrap:wrap}
    .word-letter{font-size:var(--text-2xl);font-weight:900;padding:4px 8px;border-radius:var(--radius-sm);background:var(--bg-card);border:2px solid var(--ink-light);color:var(--ink-light);transition:all var(--motion-fast)}
    .word-letter.current{background:var(--accent-light);border-color:var(--accent);color:var(--accent);transform:scale(1.1)}
    .word-letter.done{background:var(--color-success-bg);border-color:var(--color-success);color:var(--color-success)}
    .word-label{font-size:var(--text-xs);font-weight:900;color:var(--ink-secondary);margin-top:var(--s-1);text-transform:uppercase;letter-spacing:.08em}

    /* Canvas Stage */
    .stage{border:3px solid var(--ink-primary);border-radius:var(--radius-md);overflow:hidden;background:var(--bg-card)}
    .stage-header{padding:12px 14px;border-bottom:3px solid var(--ink-primary);background:var(--bg-muted);display:flex;align-items:center;justify-content:space-between;gap:var(--s-2);flex-wrap:wrap}
    .stage-info{display:flex;align-items:center;gap:var(--s-2)}
    .big-letter{font-size:var(--text-2xl);font-weight:900;color:var(--accent);min-width:40px;text-align:center}
    .stage-hint{font-size:var(--text-xs);font-weight:900;color:var(--ink-secondary);text-transform:uppercase;letter-spacing:.08em}
    .stage-score{font-size:var(--text-sm);font-weight:900;color:var(--ink-secondary)}

    .canvas-wrap{position:relative;width:100%;background:#fff;touch-action:none}
    canvas{display:block;width:100%;height:auto}
    #bgCanvas{position:relative;z-index:1}
    #drawCanvas{position:absolute;inset:0;z-index:2}

    /* Controls */
    .controls{margin-top:var(--s-2)}
    .controls-row{display:flex;gap:var(--s-2);margin-bottom:var(--s-2);flex-wrap:wrap}
    .control-box{flex:1;min-width:140px;padding:var(--s-2);background:var(--bg-muted);border:2px solid var(--ink-primary);border-radius:var(--radius-md)}
    .control-label{display:flex;align-items:center;justify-content:space-between;font-size:var(--text-xs);font-weight:900;text-transform:uppercase;letter-spacing:.08em;color:var(--ink-secondary);margin-bottom:var(--s-1)}
    .control-value{font-weight:900;color:var(--accent)}
    input[type="range"]{width:100%;margin:var(--s-1) 0;accent-color:var(--accent)}

    /* Toggle Switch */
    .toggle-row{display:flex;justify-content:space-between;align-items:center;padding:var(--s-1) 0}
    .toggle-label{font-size:var(--text-sm);font-weight:900;color:var(--ink-primary)}
    .toggle{width:52px;height:32px;background:var(--bg-canvas);border:2px solid var(--ink-primary);border-radius:16px;position:relative;cursor:pointer;transition:background var(--motion-fast)}
    .toggle::after{content:'';position:absolute;width:24px;height:24px;background:var(--bg-card);border:2px solid var(--ink-primary);border-radius:12px;top:2px;left:2px;transition:left var(--motion-fast)}
    .toggle.on{background:var(--color-success);border-color:var(--color-success)}
    .toggle.on::after{left:22px;border-color:var(--color-success)}

    /* Color Swatches */
    .swatches{display:flex;gap:8px;flex-wrap:wrap;margin-top:var(--s-1)}
    .swatch{width:36px;height:36px;border-radius:var(--radius-sm);border:2px solid var(--ink-primary);cursor:pointer;transition:transform var(--motion-fast)}
    .swatch:hover{transform:scale(1.1)}
    .swatch.active{outline:3px solid var(--accent);outline-offset:2px}

    /* Buttons */
    .btn{min-height:48px;padding:12px 14px;border-radius:var(--radius-sm);border:2px solid var(--ink-primary);background:var(--bg-card);color:var(--ink-secondary);font-family:var(--font);font-weight:900;font-size:var(--text-sm);cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:6px;transition:all var(--motion-fast) var(--ease-out);user-select:none}
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow-soft)}
    .btn:active{transform:translateY(1px);box-shadow:none}
    .btn.primary{background:var(--accent);color:white;border-color:var(--accent-dark)}
    .btn.primary:hover{filter:brightness(1.05)}
    .btn.success{background:var(--color-success);color:white;border-color:var(--color-success)}
    .btn.danger{background:var(--color-error-bg);color:var(--color-error);border-color:var(--color-error)}
    .btn:disabled{opacity:.4;cursor:not-allowed;transform:none!important}

    .actions{display:grid;grid-template-columns:repeat(3,1fr);gap:var(--s-1);margin-top:var(--s-2)}
    .actions .btn{flex:1}
    .actions-main{display:flex;gap:var(--s-2);margin-top:var(--s-2)}
    .actions-main .btn{flex:1}

    /* Feedback */
    .feedback{margin-top:var(--s-2);padding:var(--s-2);border-radius:var(--radius-sm);border:2px solid var(--ink-primary);background:var(--bg-muted);font-weight:800;font-size:var(--text-sm);color:var(--ink-secondary);display:none;align-items:flex-start;gap:10px}
    .feedback.open{display:flex}
    .feedback .ficon{font-size:18px;flex-shrink:0}
    .feedback.success{background:var(--color-success-bg);border-color:var(--color-success);color:#2D5A3A}
    .feedback.error{background:var(--color-error-bg);border-color:var(--color-error);color:#6B3A32}

    footer{flex:0 0 auto;padding:var(--s-2) var(--s-3);padding-bottom:max(var(--s-2),env(safe-area-inset-bottom));background:var(--bg-card);border-top:3px solid var(--ink-primary);display:flex;gap:var(--s-2)}
    footer .btn{flex:1}

    @media(max-width:400px){
      header{padding:0 var(--s-2)}
      .viewport{padding:var(--s-2)}
      footer{padding:var(--s-2)}
      .brand-title{font-size:var(--text-lg)}
      .actions{grid-template-columns:repeat(2,1fr)}
    }
  </style>
</head>
<body>
  <div class="app-frame">
    <header>
      <div class="brand">
        <div class="brand-title">‚úèÔ∏è Alphabet Nachspuren</div>
        <div class="brand-subtitle">Kidsneed ¬∑ Buchstaben & W√∂rter</div>
      </div>
      <div class="header-stats">
        <div class="pill" id="stats-pill">
          <span class="icon">‚≠ê</span>
          <span class="val" id="coin-count">0</span>
        </div>
      </div>
    </header>

    <main class="viewport">
      <div class="card">
        <!-- Mode Selection -->
        <section class="card-section">
          <div class="section-label">Modus w√§hlen</div>
          <div class="mode-tabs">
            <button class="mode-tab active" data-mode="letter" type="button">üî§ Buchstaben</button>
            <button class="mode-tab" data-mode="word" type="button">üìù W√∂rter</button>
          </div>

          <!-- Progress -->
          <div class="progress-wrap">
            <div class="progress-info">
              <span class="progress-label" id="progress-label">Fortschritt</span>
              <span class="progress-counter" id="progress-counter">0/30</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill"></div>
            </div>
          </div>

          <!-- Word Display (for word mode) -->
          <div class="word-display" id="word-display">
            <div class="word-letters" id="word-letters"></div>
            <div class="word-label" id="word-hint">Spure jeden Buchstaben nach</div>
          </div>
        </section>

        <!-- Canvas Stage -->
        <section class="card-section">
          <div class="stage">
            <div class="stage-header">
              <div class="stage-info">
                <div class="big-letter" id="big-letter">A</div>
                <div class="stage-hint" id="stage-hint">Spur den Buchstaben nach</div>
              </div>
              <div class="stage-score">Score: <span id="score">‚Äì</span></div>
            </div>
            <div class="canvas-wrap" id="canvas-wrap">
              <canvas id="bgCanvas"></canvas>
              <canvas id="drawCanvas"></canvas>
            </div>
          </div>

          <!-- Visibility Toggle -->
          <div class="toggle-row" style="margin-top:var(--s-2)">
            <span class="toggle-label">üëÅÔ∏è Vorlage anzeigen</span>
            <div class="toggle on" id="toggle-template" role="switch" tabindex="0"></div>
          </div>
        </section>

        <!-- Controls -->
        <section class="card-section">
          <div class="controls">
            <div class="controls-row">
              <div class="control-box">
                <div class="control-label">
                  <span>üñåÔ∏è Pinselgr√∂√üe</span>
                  <span class="control-value" id="brush-val">18</span>
                </div>
                <input type="range" id="brush-size" min="6" max="40" value="18">
                <div class="toggle-row">
                  <span class="toggle-label">üßΩ Radierer</span>
                  <div class="toggle" id="toggle-eraser" role="switch" tabindex="0"></div>
                </div>
              </div>
              <div class="control-box">
                <div class="control-label">
                  <span>üé® Farbe</span>
                </div>
                <div class="swatches" id="color-swatches">
                  <div class="swatch active" data-color="#2D2A26" style="background:#2D2A26"></div>
                  <div class="swatch" data-color="#4A7C91" style="background:#4A7C91"></div>
                  <div class="swatch" data-color="#C4726C" style="background:#C4726C"></div>
                  <div class="swatch" data-color="#7BA08A" style="background:#7BA08A"></div>
                  <div class="swatch" data-color="#8B7BA0" style="background:#8B7BA0"></div>
                </div>
              </div>
            </div>

            <div class="actions">
              <button class="btn" id="btn-prev" type="button">‚¨ÖÔ∏è Zur√ºck</button>
              <button class="btn" id="btn-next" type="button">Weiter ‚û°Ô∏è</button>
              <button class="btn" id="btn-random" type="button">üé≤ Zufall</button>
              <button class="btn" id="btn-undo" type="button">‚Ü©Ô∏è R√ºckg√§ngig</button>
              <button class="btn danger" id="btn-clear" type="button">üßº L√∂schen</button>
              <button class="btn" id="btn-check" type="button">üîç Pr√ºfen</button>
            </div>

            <div class="actions-main">
              <button class="btn success" id="btn-done" type="button">‚úÖ Fertig & Weiter</button>
            </div>
          </div>

          <div class="feedback" id="feedback">
            <span class="ficon" id="feedback-icon">üí°</span>
            <span id="feedback-text">Tipp: Spur langsam und sauber nach!</span>
          </div>
        </section>
      </div>
    </main>

    <footer>
      <a class="btn" href="https://humaneed.github.io/kidsneed/">‚Üê Hub</a>
      <button class="btn" id="btn-help" type="button">üí° Hilfe</button>
    </footer>
  </div>

  <img id="template-img" alt="" style="display:none">

  <script>
(()=>{
  'use strict';
  const $=s=>document.querySelector(s);
  const $$=s=>[...document.querySelectorAll(s)];

  // ===== LOCAL STORAGE =====
  const LS={coins:'kidsneed_coins',lettersDone:'kidsneed_alpha_letters',wordsDone:'kidsneed_alpha_words',lastIdx:'kidsneed_alpha_idx'};
  const getInt=(k,fb=0)=>{try{const v=localStorage.getItem(k);return v?parseInt(v,10)||fb:fb}catch{return fb}};
  const setStr=(k,v)=>{try{localStorage.setItem(k,String(v))}catch{}};
  const getArr=(k)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):[]}catch{return[]}};
  const setArr=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};

  // ===== TASKS DATA =====
  // Buchstaben-Boxen aus dem Bild (Koordinaten im Originalbild 1069x1500)
  const LETTERS=[
    {id:'Aa',label:'A a',box:[37,220,203,358]},
    {id:'Bb',label:'B b',box:[245,220,406,358]},
    {id:'Cc',label:'C c',box:[447,220,608,358]},
    {id:'Dd',label:'D d',box:[652,220,824,358]},
    {id:'Ee',label:'E e',box:[866,220,1019,358]},
    {id:'Ff',label:'F f',box:[39,428,175,582]},
    {id:'Gg',label:'G g',box:[236,428,407,582]},
    {id:'Hh',label:'H h',box:[445,428,604,582]},
    {id:'Ii',label:'I i',box:[699,428,781,582]},
    {id:'Jj',label:'J j',box:[893,428,995,582]},
    {id:'Kk',label:'K k',box:[40,636,190,774]},
    {id:'Ll',label:'L l',box:[241,636,366,774]},
    {id:'Mm',label:'M m',box:[416,636,639,774]},
    {id:'Nn',label:'N n',box:[654,636,822,774]},
    {id:'Oo',label:'O o',box:[859,636,1035,774]},
    {id:'Pp',label:'P p',box:[41,844,196,983]},
    {id:'Qq',label:'Q q',box:[241,844,409,983]},
    {id:'Rr',label:'R r',box:[452,844,578,983]},
    {id:'Ss',label:'S s',box:[668,844,808,983]},
    {id:'Tt',label:'T t',box:[875,844,1005,983]},
    {id:'Uu',label:'U u',box:[0,1051,201,1191]},
    {id:'Vv',label:'V v',box:[235,1051,402,1191]},
    {id:'Ww',label:'W w',box:[421,1051,637,1191]},
    {id:'Xx',label:'X x',box:[667,1051,811,1191]},
    {id:'Yy',label:'Y y',box:[878,1051,1014,1191]},
    {id:'Zz',label:'Z z',box:[39,1254,197,1400]},
    {id:'√Ñ√§',label:'√Ñ √§',box:[247,1254,403,1400]},
    {id:'√ñ√∂',label:'√ñ √∂',box:[444,1254,618,1400]},
    {id:'√ú√º',label:'√ú √º',box:[656,1254,826,1400]},
    {id:'√ü',label:'√ü',box:[905,1254,993,1400]}
  ];

  // W√∂rter f√ºr den Wort-Modus (nach Schwierigkeit sortiert)
  const WORDS=[
    {word:'OMA',hint:'Familie'},
    {word:'OPA',hint:'Familie'},
    {word:'EIS',hint:'Lecker!'},
    {word:'UHU',hint:'Klebstoff'},
    {word:'BUS',hint:'Fahrzeug'},
    {word:'HUT',hint:'Kleidung'},
    {word:'RAD',hint:'Fahrzeug'},
    {word:'ARM',hint:'K√∂rperteil'},
    {word:'OHR',hint:'K√∂rperteil'},
    {word:'ROT',hint:'Farbe'},
    {word:'BALL',hint:'Spielzeug'},
    {word:'HAUS',hint:'Geb√§ude'},
    {word:'BAUM',hint:'Natur'},
    {word:'HUND',hint:'Tier'},
    {word:'AUTO',hint:'Fahrzeug'},
    {word:'MAMA',hint:'Familie'},
    {word:'PAPA',hint:'Familie'},
    {word:'BUCH',hint:'Lesen'},
    {word:'BROT',hint:'Essen'},
    {word:'NASE',hint:'K√∂rperteil'},
    {word:'SONNE',hint:'Am Himmel'},
    {word:'WOLKE',hint:'Am Himmel'},
    {word:'BLUME',hint:'Natur'},
    {word:'KATZE',hint:'Tier'},
    {word:'VOGEL',hint:'Tier'},
    {word:'SCHULE',hint:'Lernen'},
    {word:'KINDER',hint:'Mehrzahl'},
    {word:'WASSER',hint:'Trinken'},
    {word:'ELEFANT',hint:'Tier'},
    {word:'SCHMETTERLING',hint:'Insekt'}
  ];

  // Buchstaben-Map f√ºr schnellen Zugriff
  const LETTER_MAP={};
  LETTERS.forEach((l,i)=>{
    const upper=l.id.charAt(0).toUpperCase();
    LETTER_MAP[upper]=i;
    if(l.id.length>1){
      const lower=l.id.charAt(1).toLowerCase();
      if(lower!==upper.toLowerCase())LETTER_MAP[lower]=i;
    }
  });
  // Sonderzeichen
  LETTER_MAP['√Ñ']=26;LETTER_MAP['√§']=26;
  LETTER_MAP['√ñ']=27;LETTER_MAP['√∂']=27;
  LETTER_MAP['√ú']=28;LETTER_MAP['√º']=28;
  LETTER_MAP['√ü']=29;

  // ===== STATE =====
  const state={
    mode:'letter', // 'letter' oder 'word'
    letterIdx:Math.min(getInt(LS.lastIdx,0),LETTERS.length-1),
    wordIdx:0,
    wordCharIdx:0,
    lettersDone:new Set(getArr(LS.lettersDone)),
    wordsDone:new Set(getArr(LS.wordsDone)),
    templateVisible:true,
    isEraser:false,
    brushColor:'#2D2A26',
    brushSize:18,
    undoStack:[],
    painting:false,
    lastPos:null
  };

  // ===== DOM ELEMENTS =====
  const coinCount=$('#coin-count');
  const progressLabel=$('#progress-label');
  const progressCounter=$('#progress-counter');
  const progressFill=$('#progress-fill');
  const wordDisplay=$('#word-display');
  const wordLetters=$('#word-letters');
  const wordHint=$('#word-hint');
  const bigLetter=$('#big-letter');
  const stageHint=$('#stage-hint');
  const scoreEl=$('#score');
  const feedback=$('#feedback');
  const feedbackIcon=$('#feedback-icon');
  const feedbackText=$('#feedback-text');
  const bgCanvas=$('#bgCanvas');
  const drawCanvas=$('#drawCanvas');
  const canvasWrap=$('#canvas-wrap');
  const bgCtx=bgCanvas.getContext('2d',{willReadFrequently:true});
  const drawCtx=drawCanvas.getContext('2d',{willReadFrequently:true});
  const templateImg=$('#template-img');

  let dpr=Math.max(1,Math.min(3,window.devicePixelRatio||1));
  let maskData=null,maskW=0,maskH=0;
  const UNDO_MAX=15;

  // ===== HELPERS =====
  const showFeedback=(icon,text,type='')=>{
    feedbackIcon.textContent=icon;
    feedbackText.innerHTML=text;
    feedback.className='feedback open'+(type?' '+type:'');
  };
  const hideFeedback=()=>feedback.classList.remove('open');

  const updateCoins=()=>{coinCount.textContent=getInt(LS.coins,0)};
  const addCoin=(n=1)=>{
    const c=getInt(LS.coins,0)+n;
    setStr(LS.coins,c);
    updateCoins();
    $('#stats-pill').style.transform='scale(1.1)';
    setTimeout(()=>$('#stats-pill').style.transform='',200);
  };

  const saveState=()=>{
    setStr(LS.lastIdx,state.letterIdx);
    setArr(LS.lettersDone,[...state.lettersDone]);
    setArr(LS.wordsDone,[...state.wordsDone]);
  };

  // ===== PROGRESS =====
  const updateProgress=()=>{
    if(state.mode==='letter'){
      const done=state.lettersDone.size;
      progressLabel.textContent='Buchstaben';
      progressCounter.textContent=`${done}/${LETTERS.length}`;
      progressFill.style.width=`${Math.round(done/LETTERS.length*100)}%`;
    }else{
      const done=state.wordsDone.size;
      progressLabel.textContent='W√∂rter';
      progressCounter.textContent=`${done}/${WORDS.length}`;
      progressFill.style.width=`${Math.round(done/WORDS.length*100)}%`;
    }
  };

  // ===== CANVAS SETUP =====
  const fitCanvas=()=>{
    const w=canvasWrap.clientWidth;
    const h=Math.max(260,Math.min(380,Math.round(w*0.62)));
    bgCanvas.style.height=h+'px';
    drawCanvas.style.height=h+'px';
    bgCanvas.width=Math.round(w*dpr);
    bgCanvas.height=Math.round(h*dpr);
    drawCanvas.width=Math.round(w*dpr);
    drawCanvas.height=Math.round(h*dpr);
  };

  // ===== RENDER LETTER =====
  const renderLetter=(idx)=>{
    if(idx<0||idx>=LETTERS.length)return;
    const letter=LETTERS[idx];
    bigLetter.textContent=letter.label;
    
    const isDone=state.lettersDone.has(letter.id);
    stageHint.textContent=isDone?'‚úÖ Bereits geschafft':'Spur den Buchstaben nach';
    
    hideFeedback();
    scoreEl.textContent='‚Äì';
    clearDrawing(true);
    fitCanvas();

    const [x0,y0,x1,y1]=letter.box;
    const sw=x1-x0,sh=y1-y0;

    bgCtx.save();
    bgCtx.setTransform(1,0,0,1,0,0);
    bgCtx.clearRect(0,0,bgCanvas.width,bgCanvas.height);
    bgCtx.fillStyle='#ffffff';
    bgCtx.fillRect(0,0,bgCanvas.width,bgCanvas.height);

    const pad=16*dpr;
    const cw=bgCanvas.width,ch=bgCanvas.height;
    const availW=cw-pad*2,availH=ch-pad*2;
    const scale=Math.min(availW/sw,availH/sh);
    const dw=sw*scale,dh=sh*scale;
    const dx=(cw-dw)/2,dy=(ch-dh)/2;

    // Vorlage nur zeichnen wenn sichtbar
    if(state.templateVisible&&templateImg.complete&&templateImg.naturalWidth>0){
      bgCtx.globalAlpha=0.85;
      bgCtx.imageSmoothingEnabled=true;
      bgCtx.imageSmoothingQuality='high';
      bgCtx.drawImage(templateImg,x0,y0,sw,sh,dx,dy,dw,dh);
      bgCtx.globalAlpha=1;
    }

    // Rahmen
    bgCtx.lineWidth=2*dpr;
    bgCtx.strokeStyle='rgba(45,42,38,.15)';
    bgCtx.strokeRect(dx,dy,dw,dh);
    bgCtx.restore();

    // Maske f√ºr Scoring bauen
    buildMask(x0,y0,sw,sh);
    LETTERS[idx]._map={dx,dy,dw,dh};
  };

  const buildMask=(x0,y0,sw,sh)=>{
    const mw=200,mh=200;
    maskW=mw;maskH=mh;
    const off=document.createElement('canvas');
    off.width=mw;off.height=mh;
    const oc=off.getContext('2d',{willReadFrequently:true});
    oc.clearRect(0,0,mw,mh);
    if(templateImg.complete&&templateImg.naturalWidth>0){
      oc.drawImage(templateImg,x0,y0,sw,sh,0,0,mw,mh);
    }
    const imgd=oc.getImageData(0,0,mw,mh).data;
    const m=new Uint8Array(mw*mh);
    for(let i=0,p=0;i<imgd.length;i+=4,p++){
      const r=imgd[i],g=imgd[i+1],b=imgd[i+2];
      const br=(r+g+b)/3;
      const sat=Math.max(r,g,b)-Math.min(r,g,b);
      m[p]=(br<220||sat>25)?1:0;
    }
    // Dilation
    const dil=new Uint8Array(mw*mh);
    const rad=2;
    for(let y=0;y<mh;y++){
      for(let x=0;x<mw;x++){
        let on=0;
        for(let yy=Math.max(0,y-rad);yy<=Math.min(mh-1,y+rad)&&!on;yy++){
          for(let xx=Math.max(0,x-rad);xx<=Math.min(mw-1,x+rad);xx++){
            if(m[yy*mw+xx]){on=1;break}
          }
        }
        dil[y*mw+x]=on;
      }
    }
    maskData=dil;
  };

  // ===== WORD MODE =====
  const renderWordDisplay=()=>{
    if(state.mode!=='word'){
      wordDisplay.classList.remove('active');
      return;
    }
    wordDisplay.classList.add('active');
    const w=WORDS[state.wordIdx];
    wordHint.textContent=`Hinweis: ${w.hint}`;
    wordLetters.innerHTML='';
    for(let i=0;i<w.word.length;i++){
      const span=document.createElement('span');
      span.className='word-letter';
      span.textContent=w.word[i];
      if(i<state.wordCharIdx)span.classList.add('done');
      if(i===state.wordCharIdx)span.classList.add('current');
      wordLetters.appendChild(span);
    }
  };

  const getCurrentLetterIdxForWord=()=>{
    const w=WORDS[state.wordIdx];
    const char=w.word[state.wordCharIdx];
    return LETTER_MAP[char.toUpperCase()]??0;
  };

  const advanceWord=()=>{
    const w=WORDS[state.wordIdx];
    state.wordCharIdx++;
    if(state.wordCharIdx>=w.word.length){
      // Wort fertig
      if(!state.wordsDone.has(w.word)){
        state.wordsDone.add(w.word);
        addCoin(w.word.length);
        showFeedback('üéâ',`<strong>Super!</strong> "${w.word}" geschafft! ‚≠ê +${w.word.length}`,'success');
      }else{
        showFeedback('‚ú®',`<strong>Nochmal ge√ºbt!</strong> "${w.word}" gemeistert.`,'success');
      }
      saveState();
      updateProgress();
      // N√§chstes Wort
      setTimeout(()=>{
        state.wordIdx=(state.wordIdx+1)%WORDS.length;
        state.wordCharIdx=0;
        renderTask();
      },1500);
    }else{
      renderWordDisplay();
      renderLetter(getCurrentLetterIdxForWord());
    }
  };

  // ===== RENDER TASK =====
  const renderTask=()=>{
    updateProgress();
    if(state.mode==='letter'){
      wordDisplay.classList.remove('active');
      renderLetter(state.letterIdx);
    }else{
      renderWordDisplay();
      renderLetter(getCurrentLetterIdxForWord());
    }
  };

  // ===== DRAWING =====
  const pushUndo=()=>{
    try{
      const snap=drawCtx.getImageData(0,0,drawCanvas.width,drawCanvas.height);
      state.undoStack.push(snap);
      if(state.undoStack.length>UNDO_MAX)state.undoStack.shift();
    }catch{}
  };

  const clearDrawing=(hard=false)=>{
    drawCtx.save();
    drawCtx.setTransform(1,0,0,1,0,0);
    drawCtx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
    drawCtx.restore();
    if(hard)state.undoStack=[];
  };

  const setBrushStyle=()=>{
    drawCtx.lineCap='round';
    drawCtx.lineJoin='round';
    drawCtx.lineWidth=state.brushSize*dpr;
    if(state.isEraser){
      drawCtx.globalCompositeOperation='destination-out';
      drawCtx.strokeStyle='rgba(0,0,0,1)';
    }else{
      drawCtx.globalCompositeOperation='source-over';
      drawCtx.strokeStyle=state.brushColor;
    }
  };

  const getPos=(e)=>{
    const rect=drawCanvas.getBoundingClientRect();
    return{x:(e.clientX-rect.left)*dpr,y:(e.clientY-rect.top)*dpr};
  };

  const beginDraw=(e)=>{
    state.painting=true;
    state.lastPos=getPos(e);
    pushUndo();
    setBrushStyle();
    drawCtx.beginPath();
    drawCtx.moveTo(state.lastPos.x,state.lastPos.y);
  };

  const moveDraw=(e)=>{
    if(!state.painting)return;
    const p=getPos(e);
    drawCtx.lineTo(p.x,p.y);
    drawCtx.stroke();
    state.lastPos=p;
  };

  const endDraw=()=>{
    state.painting=false;
    state.lastPos=null;
  };

  drawCanvas.addEventListener('pointerdown',e=>{drawCanvas.setPointerCapture(e.pointerId);beginDraw(e)});
  drawCanvas.addEventListener('pointermove',moveDraw);
  drawCanvas.addEventListener('pointerup',endDraw);
  drawCanvas.addEventListener('pointercancel',endDraw);
  drawCanvas.addEventListener('pointerleave',endDraw);

  // ===== SCORING =====
  const scoreDrawing=()=>{
    const idx=state.mode==='letter'?state.letterIdx:getCurrentLetterIdxForWord();
    const letter=LETTERS[idx];
    if(!maskData||!letter._map)return null;

    const{dx,dy,dw,dh}=letter._map;
    const x0=Math.max(0,Math.floor(dx));
    const y0=Math.max(0,Math.floor(dy));
    const x1=Math.min(drawCanvas.width,Math.ceil(dx+dw));
    const y1=Math.min(drawCanvas.height,Math.ceil(dy+dh));

    let img;
    try{img=drawCtx.getImageData(x0,y0,x1-x0,y1-y0).data}catch{return null}

    let drawn=0,hit=0;
    const w=x1-x0,h=y1-y0;
    const step=2;

    for(let y=0;y<h;y+=step){
      for(let x=0;x<w;x+=step){
        const i=(y*w+x)*4;
        if(img[i+3]>10){
          drawn++;
          const mx=Math.min(maskW-1,Math.max(0,Math.floor(x/w*maskW)));
          const my=Math.min(maskH-1,Math.max(0,Math.floor(y/h*maskH)));
          if(maskData[my*maskW+mx])hit++;
        }
      }
    }

    if(drawn<30)return{pct:0,drawn,hit};
    return{pct:Math.round(hit/drawn*100),drawn,hit};
  };

  // ===== MARK DONE =====
  const markDone=()=>{
    const s=scoreDrawing();
    if(s&&s.drawn>=30&&s.pct<50){
      showFeedback('üí°',`<strong>Noch nicht ganz.</strong> Treffer: ${s.pct}%. Versuch langsamer √ºber die Linien zu malen.`,'error');
      return;
    }

    if(state.mode==='letter'){
      const letter=LETTERS[state.letterIdx];
      if(!state.lettersDone.has(letter.id)){
        state.lettersDone.add(letter.id);
        addCoin(1);
        showFeedback('‚úÖ',`<strong>${letter.label} geschafft!</strong> ‚≠ê +1`,'success');
      }else{
        showFeedback('‚ú®',`<strong>Nochmal ge√ºbt!</strong> ${letter.label}`,'success');
      }
      saveState();
      updateProgress();
      // N√§chster Buchstabe
      setTimeout(()=>{
        state.letterIdx=(state.letterIdx+1)%LETTERS.length;
        renderTask();
      },1000);
    }else{
      // Word mode
      advanceWord();
    }
  };

  // ===== EVENT HANDLERS =====
  // Mode Tabs
  $$('.mode-tab').forEach(tab=>{
    tab.addEventListener('click',()=>{
      $$('.mode-tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      state.mode=tab.dataset.mode;
      state.wordCharIdx=0;
      renderTask();
    });
  });

  // Template Toggle
  $('#toggle-template').addEventListener('click',()=>{
    state.templateVisible=!state.templateVisible;
    $('#toggle-template').classList.toggle('on',state.templateVisible);
    renderTask();
  });

  // Eraser Toggle
  $('#toggle-eraser').addEventListener('click',()=>{
    state.isEraser=!state.isEraser;
    $('#toggle-eraser').classList.toggle('on',state.isEraser);
    setBrushStyle();
  });

  // Brush Size
  $('#brush-size').addEventListener('input',e=>{
    state.brushSize=parseInt(e.target.value,10)||18;
    $('#brush-val').textContent=state.brushSize;
    setBrushStyle();
  });

  // Color Swatches
  $$('.swatch').forEach(sw=>{
    sw.addEventListener('click',()=>{
      $$('.swatch').forEach(s=>s.classList.remove('active'));
      sw.classList.add('active');
      state.brushColor=sw.dataset.color;
      state.isEraser=false;
      $('#toggle-eraser').classList.remove('on');
      setBrushStyle();
    });
  });

  // Navigation
  $('#btn-prev').addEventListener('click',()=>{
    if(state.mode==='letter'){
      state.letterIdx=(state.letterIdx-1+LETTERS.length)%LETTERS.length;
    }else{
      state.wordIdx=(state.wordIdx-1+WORDS.length)%WORDS.length;
      state.wordCharIdx=0;
    }
    renderTask();
  });

  $('#btn-next').addEventListener('click',()=>{
    if(state.mode==='letter'){
      state.letterIdx=(state.letterIdx+1)%LETTERS.length;
    }else{
      state.wordIdx=(state.wordIdx+1)%WORDS.length;
      state.wordCharIdx=0;
    }
    renderTask();
  });

  $('#btn-random').addEventListener('click',()=>{
    if(state.mode==='letter'){
      state.letterIdx=Math.floor(Math.random()*LETTERS.length);
    }else{
      state.wordIdx=Math.floor(Math.random()*WORDS.length);
      state.wordCharIdx=0;
    }
    renderTask();
  });

  $('#btn-undo').addEventListener('click',()=>{
    if(state.undoStack.length){
      const snap=state.undoStack.pop();
      if(snap)drawCtx.putImageData(snap,0,0);
    }
  });

  $('#btn-clear').addEventListener('click',()=>{
    clearDrawing(false);
    scoreEl.textContent='‚Äì';
    showFeedback('üßº','<strong>Gel√∂scht.</strong> Fang nochmal an!');
  });

  $('#btn-check').addEventListener('click',()=>{
    const s=scoreDrawing();
    if(!s||s.drawn<30){
      scoreEl.textContent='‚Äì';
      showFeedback('üéØ','<strong>Mal noch etwas mehr!</strong> Es fehlt noch Farbe.');
      return;
    }
    scoreEl.textContent=s.pct+'%';
    if(s.pct>=75){
      showFeedback('üèÜ',`<strong>Sehr gut!</strong> ${s.pct}% Treffer. Super sauber!`,'success');
    }else if(s.pct>=50){
      showFeedback('üëç',`<strong>Gut!</strong> ${s.pct}% Treffer. Noch etwas genauer!`);
    }else{
      showFeedback('üí°',`<strong>Weiter √ºben!</strong> ${s.pct}% Treffer. Bleib auf der Linie.`,'error');
    }
  });

  $('#btn-done').addEventListener('click',markDone);

  $('#btn-help').addEventListener('click',()=>{
    showFeedback('üí°',`<strong>So geht's:</strong><br>
      1Ô∏è‚É£ Spur den Buchstaben langsam nach<br>
      2Ô∏è‚É£ Mit üëÅÔ∏è Vorlage ein/ausblenden<br>
      3Ô∏è‚É£ üîç Pr√ºfen zeigt deinen Score<br>
      4Ô∏è‚É£ ‚úÖ Fertig speichert & gibt ‚≠ê`);
  });

  // Resize
  window.addEventListener('resize',()=>{
    dpr=Math.max(1,Math.min(3,window.devicePixelRatio||1));
    renderTask();
  });

  // ===== INIT =====
  const init=()=>{
    updateCoins();
    $('#brush-val').textContent=state.brushSize;
    setBrushStyle();

    // Bild laden von GitHub
    templateImg.onload=()=>renderTask();
    templateImg.onerror=()=>{
      showFeedback('‚ö†Ô∏è','<strong>Bild l√§dt...</strong> Versuche es gleich nochmal.','error');
      // Fallback: lokales Bild
      templateImg.src='./abcnachspuren.jpg';
    };
    // GitHub URL
    templateImg.src='https://raw.githubusercontent.com/humaneed/kidsneed/main/ueben/alphabet-nachspuren/abcnachspuren.jpg';
  };

  init();
  console.log('‚úÖ Alphabet Nachspuren geladen.');
})();
  </script>
</body>
</html>
